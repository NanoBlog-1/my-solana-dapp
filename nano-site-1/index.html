<script>
    function getProvider() {
        if ('solana' in window && window.solana?.isPhantom) {
            return window.solana;
        }
        throw new Error('Install Phantom Wallet!');
    }

    const payButton = document.getElementById('payButton');
    const fullContent = document.getElementById('full-content');

    // Reliable devnet RPCs
    const RPC_LIST = [
        'https://solana-devnet.rpc.extrnode.com',
        'https://devnet.solana.fm/api/v1',
        'https://api.devnet.solana.com'
    ];

    let connection = null;

    async function initConnection() {
        for (const url of RPC_LIST) {
            try {
                const conn = new solanaWeb3.Connection(url, 'confirmed');
                await conn.getVersion();
                connection = conn;
                console.log('RPC Connected:', url);
                return;
            } catch (err) {
                console.warn('RPC Failed:', url);
            }
        }
        alert('No Solana connection. Try again in 1 min or use mobile data.');
    }

    payButton.addEventListener('click', async () => {
        try {
            // 1. Connect wallet
            const provider = getProvider();
            if (!provider.isConnected) {
                payButton.textContent = 'Connecting wallet...';
                await provider.connect();
            }

            // 2. Ensure RPC is ready
            if (!connection) {
                payButton.textContent = 'Connecting to Solana...';
                payButton.disabled = true;
                await initConnection();
                payButton.disabled = false;
                payButton.textContent = 'Unlock Full Article - 0.002 SOL (~$0.30)';
            }
            if (!connection) throw new Error('No RPC connection');

            // 3. YOUR WALLET ADDRESS HERE
            const recipient = new solanaWeb3.PublicKey('Bw2M5DqDsHsNZhGbmyj8WQ9iX55Gk8RPrmxpQj35aUxM');

            const amount = 0.002 * solanaWeb3.LAMPORTS_PER_SOL;

            const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash();

            const transaction = new solanaWeb3.Transaction({
                recentBlockhash: blockhash,
                feePayer: provider.publicKey,
            }).add(
                solanaWeb3.SystemProgram.transfer({
                    fromPubkey: provider.publicKey,
                    toPubkey: recipient,
                    lamports: amount,
                })
            );

            const { signature } = await provider.signAndSendTransaction(transaction);
            await connection.confirmTransaction({ signature, lastValidBlockHeight });

            fullContent.style.display = 'block';
            payButton.style.display = 'none';
            alert('Payment successful! Article unlocked.');

        } catch (error) {
            console.error('Error:', error);
            alert('Failed: ' + (error.message || 'Network error'));
        }
    });

    // Auto-init on load
    window.addEventListener('load', initConnection);
</script>
