<script>
    function getProvider() {
        if ('solana' in window) {
            const provider = window.solana;
            if (provider.isPhantom) return provider;
        }
        throw new Error('Phantom wallet not found. Install it!');
    }

    const payButton = document.getElementById('payButton');
    const fullContent = document.getElementById('full-content');

    // Auto-fallback RPC list
    const RPC_LIST = [
        'https://solana-devnet.rpc.extrnode.com',
        'https://devnet.solana.fm/api/v1',
        'https://api.devnet.solana.com'
    ];

    let connection = null;

    async function initConnection() {
        for (const url of RPC_LIST) {
            try {
                const conn = new solanaWeb3.Connection(url);
                await conn.getVersion();
                connection = conn;
                console.log('Connected to RPC:', url);
                return;
            } catch (err) {
                console.warn('RPC failed:', url);
            }
        }
        alert('All RPCs failed. Try again in 1 minute.');
    }

    payButton.addEventListener('click', async () => {
        try {
            const provider = getProvider();
            if (!provider.isConnected) await provider.connect();

            // Wait for connection
            if (!connection) {
                payButton.disabled = true;
                payButton.textContent = 'Connecting to Solana...';
                await initConnection();
                payButton.disabled = false;
                payButton.textContent = 'Unlock Full Article - 0.002 SOL (~$0.30)';
            }
            if (!connection) return;

            const recipient = new solanaWeb3.PublicKey('Bw2M5DqDsHsNZhGbmyj8WQ9iX55Gk8RPrmxpQj35aUxM'); // CHANGE THIS
            const amount = 0.002 * solanaWeb3.LAMPORTS_PER_SOL;

            const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash();

            const transaction = new solanaWeb3.Transaction({
                recentBlockhash: blockhash,
                feePayer: provider.publicKey,
            }).add(
                solanaWeb3.SystemProgram.transfer({
                    fromPubkey: provider.publicKey,
                    toPubkey: recipient,
                    lamports: amount,
                })
            );

            const { signature } = await provider.signAndSendTransaction(transaction);
            await connection.confirmTransaction({ signature, lastValidBlockHeight });

            fullContent.style.display = 'block';
            payButton.style.display = 'none';
        } catch (error) {
            console.error('Payment failed:', error);
            alert('Payment failed: ' + error.message);
        }
    });

    // Auto-connect on load
    window.addEventListener('load', initConnection);
</script>
